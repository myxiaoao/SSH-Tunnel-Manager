name: Release

on:
  push:
    tags:
      - 'v*'

env:
  CARGO_TERM_COLOR: always

jobs:
  build-macos:
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: aarch64-apple-darwin, x86_64-apple-darwin

      - name: Cache cargo registry
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            target
          key: macos-cargo-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            macos-cargo-

      - name: Install librsvg
        run: brew install librsvg

      - name: Get version
        id: version
        run: |
          VERSION=${GITHUB_REF#refs/tags/v}
          echo "version=$VERSION" >> $GITHUB_OUTPUT

      - name: Build CLI binary (universal)
        run: |
          cargo build --release --target aarch64-apple-darwin
          cargo build --release --target x86_64-apple-darwin
          mkdir -p target/release
          lipo -create \
            target/aarch64-apple-darwin/release/ssh-tunnel-manager \
            target/x86_64-apple-darwin/release/ssh-tunnel-manager \
            -output target/release/ssh-tunnel-manager

      - name: Build GUI app (universal)
        run: |
          cargo build --release --features gui --target aarch64-apple-darwin
          cargo build --release --features gui --target x86_64-apple-darwin
          lipo -create \
            target/aarch64-apple-darwin/release/ssh-tunnel-manager \
            target/x86_64-apple-darwin/release/ssh-tunnel-manager \
            -output target/release/ssh-tunnel-manager-gui

      - name: Package macOS app
        run: |
          APP_NAME="SSH Tunnel Manager"
          VERSION="${{ steps.version.outputs.version }}"
          BUNDLE_ID="com.myxiaoao.ssh-tunnel-manager"

          # Create app bundle
          APP_DIR="target/release/$APP_NAME.app"
          mkdir -p "$APP_DIR/Contents/MacOS"
          mkdir -p "$APP_DIR/Contents/Resources"

          # Copy GUI binary
          cp target/release/ssh-tunnel-manager-gui "$APP_DIR/Contents/MacOS/ssh-tunnel-manager"

          # Create launcher
          cat > "$APP_DIR/Contents/MacOS/launcher" << 'EOF'
          #!/bin/bash
          DIR="$(cd "$(dirname "$0")" && pwd)"
          exec "$DIR/ssh-tunnel-manager" --gui "$@"
          EOF
          chmod +x "$APP_DIR/Contents/MacOS/launcher"

          # Create Info.plist
          cat > "$APP_DIR/Contents/Info.plist" << PLIST
          <?xml version="1.0" encoding="UTF-8"?>
          <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
          <plist version="1.0">
          <dict>
              <key>CFBundleName</key>
              <string>$APP_NAME</string>
              <key>CFBundleDisplayName</key>
              <string>$APP_NAME</string>
              <key>CFBundleIdentifier</key>
              <string>$BUNDLE_ID</string>
              <key>CFBundleVersion</key>
              <string>$VERSION</string>
              <key>CFBundleShortVersionString</key>
              <string>$VERSION</string>
              <key>CFBundlePackageType</key>
              <string>APPL</string>
              <key>CFBundleExecutable</key>
              <string>launcher</string>
              <key>CFBundleIconFile</key>
              <string>AppIcon</string>
              <key>LSMinimumSystemVersion</key>
              <string>12.0</string>
              <key>NSHighResolutionCapable</key>
              <true/>
              <key>NSSupportsAutomaticGraphicsSwitching</key>
              <true/>
              <key>LSApplicationCategoryType</key>
              <string>public.app-category.developer-tools</string>
              <key>NSHumanReadableCopyright</key>
              <string>Copyright Â© 2026 Cooper. MIT License.</string>
              <key>CFBundleInfoDictionaryVersion</key>
              <string>6.0</string>
          </dict>
          </plist>
          PLIST

          # Generate icon
          ICONSET_DIR="$APP_DIR/Contents/Resources/AppIcon.iconset"
          mkdir -p "$ICONSET_DIR"

          cat > /tmp/icon.svg << 'SVGEOF'
          <?xml version="1.0" encoding="UTF-8"?>
          <svg width="1024" height="1024" viewBox="0 0 1024 1024" xmlns="http://www.w3.org/2000/svg">
            <defs>
              <linearGradient id="bg" x1="0%" y1="0%" x2="100%" y2="100%">
                <stop offset="0%" style="stop-color:#4F46E5"/>
                <stop offset="100%" style="stop-color:#7C3AED"/>
              </linearGradient>
            </defs>
            <rect width="1024" height="1024" rx="180" fill="url(#bg)"/>
            <g transform="translate(512, 512)">
              <rect x="-300" y="-250" width="600" height="450" rx="30" fill="#1E1B4B" stroke="#A5B4FC" stroke-width="8"/>
              <rect x="-300" y="-250" width="600" height="60" rx="30" fill="#312E81"/>
              <rect x="-300" y="-210" width="600" height="20" fill="#312E81"/>
              <circle cx="-250" cy="-220" r="15" fill="#EF4444"/>
              <circle cx="-200" cy="-220" r="15" fill="#F59E0B"/>
              <circle cx="-150" cy="-220" r="15" fill="#22C55E"/>
              <text x="0" y="-50" text-anchor="middle" font-family="monospace" font-size="120" font-weight="bold" fill="#A5B4FC">SSH</text>
              <path d="M-180 80 L180 80" stroke="#22C55E" stroke-width="16" stroke-linecap="round"/>
              <path d="M140 50 L180 80 L140 110" stroke="#22C55E" stroke-width="16" stroke-linecap="round" stroke-linejoin="round" fill="none"/>
              <path d="M-140 50 L-180 80 L-140 110" stroke="#22C55E" stroke-width="16" stroke-linecap="round" stroke-linejoin="round" fill="none"/>
            </g>
          </svg>
          SVGEOF

          for size in 16 32 64 128 256 512; do
            rsvg-convert -w $size -h $size /tmp/icon.svg > "$ICONSET_DIR/icon_${size}x${size}.png"
            rsvg-convert -w $((size*2)) -h $((size*2)) /tmp/icon.svg > "$ICONSET_DIR/icon_${size}x${size}@2x.png"
          done

          iconutil -c icns "$ICONSET_DIR" -o "$APP_DIR/Contents/Resources/AppIcon.icns"
          rm -rf "$ICONSET_DIR" /tmp/icon.svg

      - name: Create archives
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          cd target/release

          # Archive CLI binary
          tar -czvf ssh-tunnel-manager-v${VERSION}-macos-universal.tar.gz ssh-tunnel-manager

          # Archive GUI app
          zip -r "SSH-Tunnel-Manager-v${VERSION}-macos.zip" "SSH Tunnel Manager.app"

      - name: Upload CLI artifact
        uses: actions/upload-artifact@v4
        with:
          name: ssh-tunnel-manager-macos-cli
          path: target/release/ssh-tunnel-manager-v*-macos-universal.tar.gz

      - name: Upload GUI artifact
        uses: actions/upload-artifact@v4
        with:
          name: ssh-tunnel-manager-macos-app
          path: target/release/SSH-Tunnel-Manager-v*-macos.zip

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          files: |
            target/release/ssh-tunnel-manager-v*-macos-universal.tar.gz
            target/release/SSH-Tunnel-Manager-v*-macos.zip
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
